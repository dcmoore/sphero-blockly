<!DOCTYPE html>
<html>
  <head>
    <title>Sphero Page Editor</title>

    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="styles.css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

    <script src="blockly/blockly_injector.js"></script>
    <script src="common/http_client.js"></script>
    <script src="common/object_serializer.js"></script>
    <script src="sphero/commander.js"></script>
  </head>

  <body>
    <h1 id="header">Sphero Code Editor</h1>

    <div id="blockly_editor">
      <iframe id="blockly" src="blockly.html" width="100%"></iframe>

      <div id="actions">
        <div class="button-group">
          <button id="run_code">Run Code Block</button>
          <button id="set_heading">Set Heading</button>
        </div>
        <div class="button-group">
          <button id="save">Save</button>
          <button id="load">Load</button>
        </div>
      </div>
    </div>

    <script>
      var commander = new Commander(new HttpClient());

      var setHeading = document.getElementById("set_heading");
      var runCode = document.getElementById("run_code");
      var save = document.getElementById("save");
      var load = document.getElementById("load");

      setHeading.onclick = function() {
        commander.resetHeading();
      }

      runCode.onclick = function() {
        var jsCode = window.Blockly.JavaScript.workspaceToCode();

        eval(jsCode);
      }

      save.onclick = function() {
        var workspace = Blockly.getMainWorkspace();
        var xml = Blockly.Xml.workspaceToDom(workspace);

        localStorage.setItem('xml', serialize(xml));
      }

      load.onclick = function() {
        var workspace = Blockly.getMainWorkspace();
        var xml = parse(localStorage.getItem('xml'));

        workspace.clear();

        Blockly.Xml.domToWorkspace(workspace, xml)
      }

      function serialize(xml) {
        return (new XMLSerializer()).serializeToString(xml);
      }

      function parse(string) {
        return (new DOMParser()).parseFromString(string, "text/xml").firstChild;
      }
    </script>
  </body>
</html>
